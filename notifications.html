<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - UPSKILL</title>
    <!-- Tailwind CSS -->
    <link href="css/output.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/notifications.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="navbar bg-gray-900 text-white py-4 sticky top-0 z-30 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="nav-links flex space-x-6">
                <a href="index.html" class="hover:text-blue-300 transition">Home</a>
                <a href="workshops.html" class="hover:text-blue-300 transition">Workshops</a>
                <a href="aboutus.html" class="hover:text-blue-300 transition">About Us</a>
                <a href="contact.html" class="hover:text-blue-300 transition">Contact</a>
                <a href="admin-dashboard.html" class="admin-dashboard admin-only hover:text-blue-300 transition">Dashboard</a>
            </div>
            <div class="auth-buttons flex space-x-4 items-center">
                <!-- Notification Container -->
                <div id="notification-container" class="mr-4"></div>
                <a href="login.html" class="auth-btn login-btn border border-white px-4 py-2 rounded-full hover:bg-white hover:text-gray-900 transition">Log In</a>
                <a href="register.html" class="auth-btn signup-btn bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-700 transition">Sign Up</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Page Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Notifications</h1>
                        <p class="text-gray-600">Stay updated with the latest announcements and workshop changes</p>
                    </div>
                    <button onclick="markAllAsRead()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-check-double mr-2"></i>Mark All as Read
                    </button>
                </div>
            </div>

            <!-- Notifications List -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">All Notifications</h2>
                    <div class="flex gap-2">
                        <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Types</option>
                            <option value="announcement">Announcement</option>
                            <option value="workshop_update">Workshop Update</option>
                            <option value="workshop_cancelled">Workshop Cancelled</option>
                            <option value="workshop_reminder">Workshop Reminder</option>
                            <option value="system">System</option>
                        </select>
                        <button onclick="refreshNotifications()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>

                <div id="notificationsList" class="space-y-4">
                    <!-- Notifications will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                        <p>Loading notifications...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="notifications.js"></script>
    <script src="notification-component.js"></script>
    <script src="auth.js"></script>
    <script>
        let currentNotifications = [];

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Initialize notification component
                    if (document.getElementById('notification-container')) {
                        window.notificationComponent = new NotificationComponent('notification-container');
                    }
                    
                    // Load notifications
                    loadNotifications();
                    setupEventListeners();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });
        });

        function setupEventListeners() {
            // Type filter
            document.getElementById('filterType').addEventListener('change', loadNotifications);
        }

        async function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const filterType = document.getElementById('filterType').value;
            
            notificationsList.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-4"></i><p>Loading notifications...</p></div>';
            
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    notificationsList.innerHTML = '<div class="text-center py-8 text-red-500">Please log in to view notifications</div>';
                    return;
                }

                let query = firebase.firestore()
                    .collection('notifications')
                    .where('isActive', '==', true)
                    .orderBy('createdAt', 'desc');
                
                if (filterType) {
                    query = query.where('type', '==', filterType);
                }
                
                const snapshot = await query.get();
                currentNotifications = [];
                
                if (snapshot.empty) {
                    notificationsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-bell-slash text-4xl mb-4"></i>
                            <p>No notifications found</p>
                        </div>
                    `;
                    return;
                }
                
                notificationsList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const notification = doc.data();
                    notification.id = doc.id;
                    
                    // Check if notification should be shown to this user
                    if (shouldShowNotificationToUser(notification, currentUser.uid)) {
                        currentNotifications.push(notification);
                        
                        const notificationElement = createNotificationElement(notification, currentUser.uid);
                        notificationsList.appendChild(notificationElement);
                    }
                });
            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsList.innerHTML = '<div class="text-center py-8 text-red-500">Error loading notifications</div>';
            }
        }

        function shouldShowNotificationToUser(notification, userId) {
            if (notification.targetUsers === 'all') {
                return true;
            }
            
            if (notification.targetUsers === 'registered') {
                return true;
            }
            
            if (Array.isArray(notification.targetUsers)) {
                return notification.targetUsers.includes(userId);
            }
            
            return false;
        }

        function createNotificationElement(notification, userId) {
            const div = document.createElement('div');
            const isUnread = !notification.readBy || !notification.readBy.includes(userId);
            
            div.className = `notification-item ${isUnread ? 'unread' : ''} cursor-pointer hover:bg-gray-50 transition-colors`;
            div.onclick = () => markAsRead(notification.id);
            
            const createdAt = notification.createdAt?.toDate() || new Date();
            const formattedDate = new Intl.DateTimeFormat('en-US', {
                dateStyle: 'medium',
                timeStyle: 'short'
            }).format(createdAt);
            
            div.innerHTML = `
                <div class="notification-content">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-800">${notification.title}</h4>
                        <span class="notification-type ${notification.type}">${notification.type}</span>
                    </div>
                    <p class="text-gray-600 mb-3">${notification.message}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span>${formattedDate}</span>
                        ${isUnread ? '<span class="text-blue-600 font-medium">New</span>' : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        async function markAsRead(notificationId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            try {
                await firebase.firestore()
                    .collection('notifications')
                    .doc(notificationId)
                    .update({
                        readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                
                // Refresh the display
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllAsRead() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            try {
                const batch = firebase.firestore().batch();
                
                currentNotifications.forEach(notification => {
                    if (!notification.readBy || !notification.readBy.includes(currentUser.uid)) {
                        const notificationRef = firebase.firestore()
                            .collection('notifications')
                            .doc(notification.id);
                        batch.update(notificationRef, {
                            readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                        });
                    }
                });
                
                await batch.commit();
                
                // Refresh the display
                loadNotifications();
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        function refreshNotifications() {
            loadNotifications();
        }
    </script>
</body>
</html>
