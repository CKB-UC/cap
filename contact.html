<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact - UPSKILL</title>
    <link rel="stylesheet" href="style.css">
    <link href="css/output.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/footer.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="navbar bg-gray-900 text-white py-4 sticky top-0 z-30 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="nav-links flex space-x-6">
                <a href="index.html" class="hover:text-blue-300 transition">Home</a>
                <a href="workshops.html" class="hover:text-blue-300 transition">Workshops</a>
                <a href="aboutus.html" class="hover:text-blue-300 transition">About Us</a>
                <a href="contact.html" class="active bg-blue-600 px-4 py-2 rounded-full">Contact</a>
                <a href="admin-dashboard.html" class="admin-dashboard admin-only hover:text-blue-300 transition">Dashboard</a>
            </div>
            <div class="auth-buttons flex space-x-4 items-center">
                <!-- Notification Container - Only shown when logged in -->
                <div id="notification-container" class="mr-4 hidden"></div>
                <a href="login.html" class="auth-btn login-btn border border-white px-4 py-2 rounded-full hover:bg-white hover:text-gray-900 transition">Log In</a>
                <a href="register.html" class="auth-btn signup-btn bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-700 transition">Sign Up</a>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Contact UPSKILL</h1>
            <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto">Get in touch with our team for any inquiries or support</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Send us a message</h2>
            <form id="contactForm" class="space-y-6">
                <!-- Name and Email fields - hidden when user is logged in -->
                <div id="nameField" class="user-info-field">
                    <label for="name" class="block text-gray-700 font-medium mb-2">Name</label>
                    <input type="text" id="name" name="name" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g. Jan Ray Mamaril">
                </div>

                <div id="emailField" class="user-info-field">
                    <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                    <input type="email" id="email" name="email" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g. Mamaril1234@gmail.com">
                </div>

                <!-- User info display when logged in -->
                <div id="userInfoDisplay" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-user-circle text-blue-600 mr-3 text-xl"></i>
                        <div>
                            <p class="text-sm text-blue-600 font-medium">Sending as logged-in user</p>
                            <p class="text-gray-700" id="userInfoText"></p>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="subject" class="block text-gray-700 font-medium mb-2">Subject</label>
                    <input type="text" id="subject" name="subject" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g. Workshop Inquiry">
                </div>

                <div>
                    <label for="message" class="block text-gray-700 font-medium mb-2">Message</label>
                    <textarea id="message" name="message" rows="5" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Your Message"></textarea>
                </div>

                <button type="submit" id="submitBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                    <span id="submitText">Send Message</span>
                    <div id="submitSpinner" class="hidden ml-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    </div>
                </button>
            </form>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>Message sent successfully! We'll get back to you soon.</span>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorText">An error occurred. Please try again.</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Chatbot Icon -->
    <div id="chatbot-icon" class="fixed bottom-5 left-5 w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:bg-blue-600 transition-all duration-300 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </div>

    <!-- Chatbot Container -->
    <div id="chatbot-container" class="fixed bottom-24 left-5 w-80 h-96 bg-white rounded-lg shadow-xl flex flex-col overflow-hidden hidden z-40">
        <!-- Header -->
        <div class="bg-blue-500 text-white p-4 flex justify-between items-center">
            <span class="font-medium">Navigation Assistant</span>
            <button id="close-chat" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Messages Area -->
        <div id="chatbot-messages" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-3">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-gray-200 p-3 bg-gray-50">
            <div class="flex rounded-md overflow-hidden">
                <input type="text" id="user-input" placeholder="How can I help you navigate?" class="flex-grow px-4 py-2 focus:outline-none" />
                <button id="send-message" class="bg-blue-500 text-white px-4 flex items-center justify-center hover:bg-blue-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 py-12">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4">About UPSKILL</h3>
                    <p class="text-gray-600">
                        Our mission is to provide accessible, research-based soft skills training to help individuals thrive in their careers.
                    </p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="workshops.html" class="text-blue-600 hover:underline">Workshops</a></li>
                        <li><a href="aboutus.html" class="text-blue-600 hover:underline">About Us</a></li>
                        <li><a href="contact.html" class="text-blue-600 hover:underline">Contact</a></li>
                        <li><a href="privacy.html" class="text-blue-600 hover:underline">Privacy Policy</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Contact Info</h3>
                    <ul class="space-y-2 text-gray-600">
                        <li><i class="fas fa-map-marker-alt mr-2 text-blue-600"></i> Room 316 B Lopez Building</li>
                        <li><i class="fas fa-phone mr-2 text-blue-600"></i> 0908-340-8351</li>
                        <li><i class="fas fa-envelope mr-2 text-blue-600"></i> info@upskill.com</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-200 mt-8 pt-8 text-center text-gray-500">
                <p>&copy; 2023 UPSKILL. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script src="notifications.js"></script>
    <script src="notification-component.js"></script>
    <link rel="stylesheet" href="css/notifications.css">
    <script src="chatbot.js"></script>
    <script>
            // Initialize auth state for navigation
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged((user) => {
                updateNavigationAuthState(user);
                
                // Handle contact form fields based on authentication
                handleContactFormAuth(user);
                
                // Initialize notification component if user is logged in
                if (user) {
                    console.log('User logged in, initializing notification component for user:', user.uid);
                    // Show notification container
                    const notificationContainer = document.getElementById('notification-container');
                    if (notificationContainer) {
                        notificationContainer.classList.remove('hidden');
                        // Wait a bit for the DOM to be ready
                        setTimeout(() => {
                            console.log('Creating notification component for user:', user.uid);
                            window.notificationComponent = new NotificationComponent('notification-container');
                        }, 100);
                    } else {
                        console.error('Notification container not found');
                    }
                } else {
                    console.log('No user logged in, hiding notification container');
                    // Hide notification container when not logged in
                    const notificationContainer = document.getElementById('notification-container');
                    if (notificationContainer) {
                        notificationContainer.classList.add('hidden');
                        // Clean up existing notification component
                        if (window.notificationComponent) {
                            window.notificationComponent.destroy();
                            window.notificationComponent = null;
                        }
                    }
                }
            });

        // Function to handle contact form authentication
        function handleContactFormAuth(user) {
            const nameField = document.getElementById('nameField');
            const emailField = document.getElementById('emailField');
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const userInfoText = document.getElementById('userInfoText');
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');

            if (user) {
                // User is logged in - hide name/email fields and show user info
                nameField.classList.add('hidden');
                emailField.classList.add('hidden');
                userInfoDisplay.classList.remove('hidden');
                
                // Display user info
                const displayName = user.displayName || user.email.split('@')[0];
                userInfoText.textContent = `${displayName} (${user.email})`;
                
                // Pre-fill hidden inputs with user data
                nameInput.value = displayName;
                emailInput.value = user.email;
                
                // Remove required attribute since fields are hidden
                nameInput.removeAttribute('required');
                emailInput.removeAttribute('required');
            } else {
                // User is not logged in - show name/email fields
                nameField.classList.remove('hidden');
                emailField.classList.remove('hidden');
                userInfoDisplay.classList.add('hidden');
                
                // Clear any pre-filled values
                nameInput.value = '';
                emailInput.value = '';
                
                // Add required attribute back
                nameInput.setAttribute('required', '');
                emailInput.setAttribute('required', '');
            }
        }

        // Contact form submission
        const contactForm = document.getElementById('contactForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Contact form submitted');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'Sending...';
            submitSpinner.classList.remove('hidden');
            
            // Hide any existing messages
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                // Get form data
                const formData = new FormData(contactForm);
                const messageData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    subject: formData.get('subject'),
                    message: formData.get('message'),
                    createdAt: new Date(),
                    status: 'unread',
                    userId: auth.currentUser ? auth.currentUser.uid : null,
                    userEmail: auth.currentUser ? auth.currentUser.email : formData.get('email')
                };

                console.log('Message data to save:', messageData);

                // Save message to Firestore
                const docRef = await db.collection('contactMessages').add(messageData);
                console.log('Message saved with ID:', docRef.id);

                // Send notification to admins
                await sendAdminNotification(messageData);
                console.log('Admin notifications sent');

                // Show success message
                successMessage.classList.remove('hidden');
                contactForm.reset();

                // Re-apply authentication state to form fields
                if (auth.currentUser) {
                    handleContactFormAuth(auth.currentUser);
                }

                // Auto-hide success message after 5 seconds
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 5000);

            } catch (error) {
                console.error('Error sending message:', error);
                errorText.textContent = `Failed to send message: ${error.message}. Please try again.`;
                errorMessage.classList.remove('hidden');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.textContent = 'Send Message';
                submitSpinner.classList.add('hidden');
            }
        });

        // Function to send notification to admins
        async function sendAdminNotification(messageData) {
            try {
                console.log('Sending admin notifications for message:', messageData.subject);
                
                // Get all admin users
                const adminSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .get();

                console.log('Found admin users:', adminSnapshot.size);

                if (!adminSnapshot.empty) {
                    // Create notification for each admin
                    const adminNotifications = adminSnapshot.docs.map(doc => {
                        const notificationData = {
                            title: `New Contact Message: ${messageData.subject}`,
                            message: `From: ${messageData.name} (${messageData.email})\n\nMessage: ${messageData.message}`,
                            type: 'system',
                            priority: 'high',
                            targetUsers: [doc.id], // Send to specific admin
                            createdAt: new Date(),
                            createdBy: 'system',
                            relatedTo: 'contact_message'
                        };
                        
                        console.log('Creating notification for admin:', doc.id, notificationData);
                        return db.collection('notifications').add(notificationData);
                    });

                    await Promise.all(adminNotifications);
                    console.log('All admin notifications created successfully');
                } else {
                    console.log('No admin users found');
                }
            } catch (error) {
                console.error('Error sending admin notification:', error);
                // Don't throw error here as the main message was already saved
            }
        }
    });
    </script>
</body>
</html>